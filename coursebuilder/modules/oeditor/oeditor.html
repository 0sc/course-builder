<!-- TODO(psimakov): use local YUI library -->
<link rel="stylesheet" href="http://yui.yahooapis.com/3.6.0/build/cssgrids/grids-min.css">
<link rel="stylesheet" href="http://yui.yahooapis.com/combo?3.6.0/build/cssreset/reset-min.css&3.6.0/build/cssfonts/fonts-min.css">
<script src="http://yui.yahooapis.com/3.6.0/build/yui/yui.js"></script>

<link href="/static/inputex-3.1.0/src/inputex/assets/skins/sam/inputex.css" rel="stylesheet">
<script src="/static/inputex-3.1.0/src/loader.js" type='text/javascript'></script>
<script src="/static/inputex-3.1.0/lib/jsonPretty.js" type='text/javascript'></script>

<!-- TODO(psimakov): take styles out into a separate file -->
<style>
  fieldset {
    border: none;
    border-top: solid 1px #9999FF;
  }
  div.inputEx-StringField-wrapper input {
    width: 460px;
    margin-top: 2px;
    margin-bottom: 2px;
    padding: 2px;
    text-align: left;
    border: solid 1px #999999;    
  }
  div.inputex-form-buttonbar {
    margin: 0px;
    padding-left: 8px;
    padding-top: 18px;
    border-top: solid 1px #9999FF;
    text-align: center;
  }
  div.inputex-form-buttonbar a {
    text-decoration: none;
    background-color: #A0A0FF;
    padding: 4px;
    padding-left: 16px;
    padding-right: 16px;
    margin-right: 16px;
    font-weight: bold;
    color: #000000;
  }
  fieldset legend span {
    color: #505050;
    font-weight: bold;
  }
  a.inputex-list-link {
    float: right;
  }
  div.inputEx-StringField-wrapper {
    width: 460px;
  }
  div.inputEx-StringField-wrapper textarea {
    width: 100%;
  }

  body {
    font: 13px/1.231 arial,helvetica,clean,sans-serif;
  }
  div#menu {
    width: 100%;
    background-color: #F0F0F0;
    padding: 4px;
    text-align: center;
  }
  div.form {
    width: 700px;
    background-color: #DDDDFF;
    border: 1px solid #9999FF;
    margin: 20px;
    padding: 15px;
    display: none;
    text-align: left;
  }
  div.status-message {
    width:400px;   /* adjust */
    top:15%;
    left:50%;
    margin-left: -200px;  /* half of the width */
    position:fixed;
    background-color: rgb(255, 0, 0);
    background-color: rgba(255, 255, 0, 0.5);
    xtransparency: 50%;
    text-align: center;
    padding: 16px;
    z-index: 999;
  }
</style>

<div class='status-message' id='formStatusMessage' style='display: none;'>&nbsp;</div>

<div style='width: 100%;' align='center'>
  <div class='form' id='formContainer'></div>
</div>

<!-- TODO(psimakov): take most of JS out into a separate file -->
<script type='text/javascript'>
  function cbShowMsg(text){
    elem = document.getElementById("formStatusMessage");
    elem.innerText = text;
    elem.style.display = "block";
  }
  
  function cbHideMsg(){
  elem = document.getElementById("formStatusMessage");
    elem.style.display = "none";
  }

  // set initial UI state
  document.getElementById("formContainer").style.display = "none";
  cbShowMsg("Loading...");

  // keep all our global objects here
  cb_global = {};
  
  // set home folder
  YUI_config.groups.inputex.base = '/static/inputex-3.1.0/src/';
  
  YUI({filter: "raw"}).use(
    'querystring-stringify-simple',
    'inputex-group','inputex-select','inputex-string','inputex-form',
    'inputex-radio','inputex-date','inputex-datepicker','inputex-jsonschema',
    'inputex-checkbox','inputex-list','inputex-color','inputex-rte','inputex-textarea',
    function (Y) {
  
      // here is the object schema
      var schema = {
        root : {{ schema }}
      };

      // inject inputex annotations
      if (!schema.root["title"]) {
        schema.root["title"] = "{{ type_label }}";
      }

      // build form definition from the json schema
      builder = new Y.inputEx.JsonSchema.Builder({
        'schemaIdentifierMap': schema
      });
      inputExDefinition = builder.schemaToInputEx(schema.root);
  
      // bind buttons
      inputExDefinition.buttons = [
        {type: 'submit-link', value: 'Save', onClick:function() {
            cbShowMsg("Saving...");

            // record current state
            var lastSavedFormValue = cb_global.form.getValue();

            // format request
            var request_save = {{ post_args }};
            request_save.payload = JSON.stringify(lastSavedFormValue);
            request_data = {"request": JSON.stringify(request_save)};

            // async post data to the server
            var url = '{{ post_url }}';

            Y.io(url, {
              method: 'PUT',
              data: request_data,
              timeout : 3000,
              on: {
                  success: function(id, o, args) {
                    var json = JSON.parse(o.responseText);

                    if (json.status != 200) {
                      msg = "Unknown error (" + json.status + ").";
                      if (json.message) {
                        msg = json.message;
                      }
                      cbShowMsg("Server error; error code " + json.status + ". " + msg);
                      return
                    }
  
                    // save lastSavedFormValue
                    cb_global.lastSavedFormValue = lastSavedFormValue;
  
                    // update UI
                    cbShowMsg(json.message);
                    setTimeout(function(){ cbHideMsg(); }, 750);
                  },
                  failure : function (x,o) {
                      cbShowMsg("Server did not respond. Please reload the page to try again.");
                  }
              }
            });

            return false;
        }},

        {type: 'link', value: 'Close', onClick:function(e) {
          lastSavedFormValue = cb_global.lastSavedFormValue.toPrettyJSONString(true);
          now = cb_global.form.getValue().toPrettyJSONString(true);
          if (lastSavedFormValue == now || confirm("Abandon all changes?")) {
            // TODO(psimakov): use exit_url
            history.back();
          }

        }}
      ];

      // create form and bind it to DOM
      inputExDefinition.parentEl = 'formContainer';
      cb_global.form = new Y.inputEx.Form(inputExDefinition);
  
      // async get data from the sever and push it into the form when ready
      var url = '{{ get_url }}';
  
      // request data for object being edited
      Y.io(url, {
        method: 'GET',
        timeout : 3000,
        on: {
            success: function(id, o, args) {
              var json = JSON.parse(o.responseText);
  
              // check status code
              if (json.status != 200) {
                msg = "Unknown error (" + json.status + ").";
                if (json.message) {
                  msg = json.message;
                }
                cbShowMsg("Server error; error code " + json.status + ". " + msg);
                return
              }
  
              // check payload
              if (!json.payload) {
                cbShowMsg("Server error; server sent no payload.");
                return
              }
  
              // push payload into form
              payload = JSON.parse(json.payload);
              cb_global.form.setValue(payload);
                          
              // save lastSavedFormValue
              cb_global.original = payload;
              cb_global.lastSavedFormValue = payload;
               
              // it is better to set lastSavedFormValue to a cb_global.form.getValue(),
              // but it does not work for rich edit control as it has delayed loading
              // and may not be ready when this line above is executed
  
              // update ui state
              document.getElementById("formContainer").style.display = "block";
              cbShowMsg(json.message);
              setTimeout(function(){ cbHideMsg(); }, 750);
            },
            failure : function (x,o) {
                cbShowMsg("Server did not respond. Please reload the page to try again.");
            }
        }
      });

  });
</script>